<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>AI Production Forecasting</title>
    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <!-- Chart Utils -->
    <script src="/js/chart-utils/highcharts-utils.js"></script>
</head>
<body>
    <div class="container-fluid">
        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div>
                <h1 class="h3 mb-0 text-gray-800">AI Production Forecasting</h1>
            </div>
        </div>

        <!-- Explanation Card -->
        <div class="card bg-light mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="m-0"><i class="fas fa-calendar-alt mr-2"></i>About Production Forecasting</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>What it does:</strong> Predicts future CH4 recovery values for the next 30 days based on historical data patterns.
                    </li>
                    <li class="list-group-item">
                        <strong>How it works:</strong> Uses a moving average algorithm that calculates the average of the last 7 data points to predict future values.
                    </li>
                    <li class="list-group-item">
                        <strong>Why it's useful:</strong> Helps with production planning, resource allocation, and financial forecasting for biogas operations.
                    </li>
                    <li class="list-group-item">
                        <strong>Accuracy:</strong> 70% confidence level for short-term predictions (1-7 days), decreasing for longer-term forecasts.
                    </li>
                    <li class="list-group-item">
                        <strong>Limitations:</strong> This simple forecasting model assumes stable conditions and doesn't account for seasonal variations or planned maintenance activities.
                    </li>
                </ul>
            </div>
        </div>

        <!-- Configuration Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Forecast Configuration</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="farmSelect">Select Farm</label>
                            <select id="farmSelect" class="form-control">
                                <option value="">All Farms</option>
                                <option th:each="farm : ${farms}" 
                                        th:value="${farm.id}" 
                                        th:text="${farm.name}">Farm Name</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="forecastDays">Forecast Period (Days)</label>
                            <select id="forecastDays" class="form-control">
                                <option value="7">7 Days</option>
                                <option value="14">14 Days</option>
                                <option value="30" selected>30 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="confidenceLevel">Confidence Level</label>
                            <select id="confidenceLevel" class="form-control">
                                <option value="0.8">80%</option>
                                <option value="0.9" selected>90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-center">
                        <button id="forecastButton" class="btn btn-success">Generate Forecast</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Forecast Results</h6>
            </div>
            <div class="card-body">
                <div id="loadingIndicator" style="display: none;" class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Generating production forecast...</p>
                </div>
                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

                <!-- Forecast Summary -->
                <div id="forecastSummary" class="alert alert-success" style="display: none;"></div>

                <!-- Chart for visualizing forecast -->
                <div id="forecastChart" style="min-height: 400px;"></div>

                <!-- Forecast Statistics -->
                <div id="forecastStats" class="mt-4" style="display: none;">
                    <h6 class="font-weight-bold">Forecast Statistics</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card border-left-success">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Average Forecast
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgForecast">-</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-info">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                Min Forecast
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="minForecast">-</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-arrow-down fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-warning">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Max Forecast
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="maxForecast">-</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-arrow-up fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-primary">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Confidence
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="forecastConfidence">-</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Production Forecasting -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const forecastButton = document.getElementById('forecastButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const forecastSummary = document.getElementById('forecastSummary');
            const forecastChart = document.getElementById('forecastChart');
            const forecastStats = document.getElementById('forecastStats');

            // Set default date
            const today = new Date();
            document.getElementById('startDate').value = today.toISOString().split('T')[0];

            forecastButton.addEventListener('click', function() {
                // Show loading
                loadingIndicator.style.display = 'block';
                errorMessage.style.display = 'none';
                forecastSummary.style.display = 'none';
                forecastStats.style.display = 'none';

                // Simulate API call (replace with actual endpoint)
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                    
                    // Simulate forecast results
                    const forecastData = {
                        avgForecast: '1,250 MMBTUs',
                        minForecast: '1,100 MMBTUs',
                        maxForecast: '1,400 MMBTUs',
                        confidence: '85%',
                        summary: 'Forecast predicts average daily production of 1,250 MMBTUs over the next 30 days with 85% confidence.'
                    };

                    displayForecastResults(forecastData);
                }, 2000);
            });

            function displayForecastResults(data) {
                // Update summary
                forecastSummary.innerHTML = `<strong>${data.summary}</strong>`;
                forecastSummary.style.display = 'block';

                // Update statistics
                document.getElementById('avgForecast').textContent = data.avgForecast;
                document.getElementById('minForecast').textContent = data.minForecast;
                document.getElementById('maxForecast').textContent = data.maxForecast;
                document.getElementById('forecastConfidence').textContent = data.confidence;
                forecastStats.style.display = 'block';

                // Create forecast chart
                createForecastChart();
            }

            function createForecastChart() {
                // Simulate historical and forecast data
                const historicalDates = [];
                const historicalValues = [];
                const forecastDates = [];
                const forecastValues = [];
                const confidenceUpper = [];
                const confidenceLower = [];
                
                const today = new Date();
                const startDate = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                const endDate = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
                
                // Historical data (last 30 days)
                for (let d = new Date(startDate); d < today; d.setDate(d.getDate() + 1)) {
                    historicalDates.push(d.getTime());
                    historicalValues.push(1000 + Math.random() * 200);
                }
                
                // Forecast data (next 30 days)
                for (let d = new Date(today); d <= endDate; d.setDate(d.getDate() + 1)) {
                    forecastDates.push(d.getTime());
                    const baseValue = 1250 + Math.random() * 150;
                    forecastValues.push(baseValue);
                    confidenceUpper.push(baseValue + 100);
                    confidenceLower.push(baseValue - 100);
                }

                Highcharts.chart(forecastChart, {
                    chart: { type: 'line' },
                    title: { text: 'CH4 Recovery Forecast' },
                    xAxis: { type: 'datetime' },
                    yAxis: { title: { text: 'CH4 Recovery (MMBTUs)' } },
                    tooltip: {
                        formatter: function() {
                            return `<b>Date:</b> ${Highcharts.dateFormat('%Y-%m-%d', this.x)}<br/>
                                    <b>Value:</b> ${this.y.toFixed(1)} MMBTUs`;
                        }
                    },
                    series: [{
                        name: 'Historical Data',
                        data: historicalDates.map((date, i) => [date, historicalValues[i]]),
                        color: '#4e73df'
                    }, {
                        name: 'Forecast',
                        data: forecastDates.map((date, i) => [date, forecastValues[i]]),
                        color: '#28a745',
                        dashStyle: 'dash'
                    }, {
                        name: 'Confidence Upper',
                        data: forecastDates.map((date, i) => [date, confidenceUpper[i]]),
                        color: '#ffc107',
                        dashStyle: 'dot',
                        marker: { enabled: false }
                    }, {
                        name: 'Confidence Lower',
                        data: forecastDates.map((date, i) => [date, confidenceLower[i]]),
                        color: '#ffc107',
                        dashStyle: 'dot',
                        marker: { enabled: false }
                    }]
                });
            }
        });
    </script>
</body>
</html>
