<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>AI Trend Analysis</title>
    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <!-- Chart Utils -->
    <script src="/js/chart-utils/highcharts-utils.js"></script>
</head>
<body>
    <div class="container-fluid">
        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div>
                <h1 class="h3 mb-0 text-gray-800">AI Trend Analysis</h1>
            </div>
        </div>

        <!-- Explanation Card -->
        <div class="card bg-light mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="m-0"><i class="fas fa-chart-line mr-2"></i>About Trend Analysis</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <strong>What it does:</strong> Analyzes historical CH4 recovery data to identify patterns, trends, and seasonal variations in biogas production.
                    </li>
                    <li class="list-group-item">
                        <strong>How it works:</strong> Uses time series analysis and statistical methods to detect upward, downward, or cyclical trends in production data.
                    </li>
                    <li class="list-group-item">
                        <strong>Why it's useful:</strong> Helps understand production patterns, plan maintenance schedules, and optimize operational strategies.
                    </li>
                    <li class="list-group-item">
                        <strong>Analysis methods:</strong> Linear regression, moving averages, and seasonal decomposition.
                    </li>
                    <li class="list-group-item">
                        <strong>Limitations:</strong> Requires sufficient historical data (minimum 30 days) for accurate trend detection. Short-term fluctuations may mask underlying trends.
                    </li>
                </ul>
            </div>
        </div>

        <!-- Configuration Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Analysis Configuration</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="farmSelect">Select Farm</label>
                            <select id="farmSelect" class="form-control">
                                <option value="">All Farms</option>
                                <option th:each="farm : ${farms}" 
                                        th:value="${farm.id}" 
                                        th:text="${farm.name}">Farm Name</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="trendType">Trend Type</label>
                            <select id="trendType" class="form-control">
                                <option value="linear">Linear Trend</option>
                                <option value="seasonal">Seasonal Pattern</option>
                                <option value="moving-average">Moving Average</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" class="form-control" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-center">
                        <button id="analyzeButton" class="btn btn-info">Analyze Trend</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Trend Analysis Results</h6>
            </div>
            <div class="card-body">
                <div id="loadingIndicator" style="display: none;" class="text-center">
                    <div class="spinner-border text-info" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing trend data...</p>
                </div>
                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

                <!-- Trend Summary -->
                <div id="trendSummary" class="alert alert-info" style="display: none;"></div>

                <!-- Chart for visualizing trend -->
                <div id="trendChart" style="min-height: 400px;"></div>

                <!-- Trend Statistics -->
                <div id="trendStats" class="mt-4" style="display: none;">
                    <h6 class="font-weight-bold">Trend Statistics</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card border-left-primary">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Trend Direction
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="trendDirection">-</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-arrow-up fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-success">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Slope
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="trendSlope">-</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-info">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                RÂ² Value
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="trendRSquared">-</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-warning">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Confidence
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="trendConfidence">-</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Trend Analysis -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeButton = document.getElementById('analyzeButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const trendSummary = document.getElementById('trendSummary');
            const trendChart = document.getElementById('trendChart');
            const trendStats = document.getElementById('trendStats');

            // Set default dates
            const today = new Date();
            const ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
            
            document.getElementById('startDate').value = ninetyDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];

            analyzeButton.addEventListener('click', function() {
                // Show loading
                loadingIndicator.style.display = 'block';
                errorMessage.style.display = 'none';
                trendSummary.style.display = 'none';
                trendStats.style.display = 'none';

                // Simulate API call (replace with actual endpoint)
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                    
                    // Simulate trend analysis results
                    const trendData = {
                        direction: 'Upward',
                        slope: '+2.3%',
                        rSquared: '0.85',
                        confidence: 'High',
                        summary: 'Strong upward trend detected with 85% confidence level. Production has increased by 2.3% per day on average.'
                    };

                    displayTrendResults(trendData);
                }, 2000);
            });

            function displayTrendResults(data) {
                // Update summary
                trendSummary.innerHTML = `<strong>${data.summary}</strong>`;
                trendSummary.style.display = 'block';

                // Update statistics
                document.getElementById('trendDirection').textContent = data.direction;
                document.getElementById('trendSlope').textContent = data.slope;
                document.getElementById('trendRSquared').textContent = data.rSquared;
                document.getElementById('trendConfidence').textContent = data.confidence;
                trendStats.style.display = 'block';

                // Create trend chart
                createTrendChart();
            }

            function createTrendChart() {
                // Simulate trend data
                const dates = [];
                const values = [];
                const trendLine = [];
                
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    dates.push(d.getTime());
                    const baseValue = 1000 + Math.random() * 200;
                    values.push(baseValue);
                    trendLine.push(950 + (d.getTime() - startDate.getTime()) / (24 * 60 * 60 * 1000) * 2.3);
                }

                Highcharts.chart(trendChart, {
                    chart: { type: 'line' },
                    title: { text: 'CH4 Recovery Trend Analysis' },
                    xAxis: { type: 'datetime' },
                    yAxis: { title: { text: 'CH4 Recovery (MMBTUs)' } },
                    tooltip: {
                        formatter: function() {
                            return `<b>Date:</b> ${Highcharts.dateFormat('%Y-%m-%d', this.x)}<br/>
                                    <b>Value:</b> ${this.y.toFixed(1)} MMBTUs`;
                        }
                    },
                    series: [{
                        name: 'Actual Data',
                        data: dates.map((date, i) => [date, values[i]]),
                        color: '#4e73df'
                    }, {
                        name: 'Trend Line',
                        data: dates.map((date, i) => [date, trendLine[i]]),
                        color: '#e74a3b',
                        dashStyle: 'dash'
                    }]
                });
            }
        });
    </script>
</body>
</html>
