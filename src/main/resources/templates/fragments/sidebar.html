<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <!-- Sidebar Fragment -->
    <ul th:fragment="sidebar" class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <!-- Sidebar - Company Selector -->
        <div class="sidebar-brand d-flex align-items-center justify-content-between p-2">
            <div th:replace="fragments/company-selector :: company-selector"></div>
        </div>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">

        <!-- Nav Item - Dashboard -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/}">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </li>

        <!-- Nav Item - Farm Management -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/admin/farms}">
                <i class="fas fa-fw fa-barn"></i>
                <span>Farms</span>
            </a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Interface
        </div>

        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-fw fa-cog"></i>
                <span>Components</span>
            </a>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Custom Components:</h6>
                    <a class="collapse-item" th:href="@{/buttons}">Buttons</a>
                    <a class="collapse-item" th:href="@{/cards}">Cards</a>
                </div>
            </div>
        </li>

        <!-- Nav Item - Utilities Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                aria-expanded="true" aria-controls="collapseUtilities">
                <i class="fas fa-fw fa-wrench"></i>
                <span>Utilities</span>
            </a>
            <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Custom Utilities:</h6>
                    <a class="collapse-item" th:href="@{/utilities-color}">Colors</a>
                    <a class="collapse-item" th:href="@{/utilities-border}">Borders</a>
                    <a class="collapse-item" th:href="@{/utilities-animation}">Animations</a>
                    <a class="collapse-item" th:href="@{/utilities-other}">Other</a>
                </div>
            </div>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Addons
        </div>

        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link" href="#" data-toggle="collapse" data-target="#collapsePages" aria-expanded="true"
                aria-controls="collapsePages">
                <i class="fas fa-fw fa-folder"></i>
                <span>Pages</span>
            </a>
            <div id="collapsePages" class="collapse" aria-labelledby="headingPages"
                data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Login Screens:</h6>
                    <a class="collapse-item" th:href="@{/login}">Login</a>
                    <a class="collapse-item" th:href="@{/register}">Register</a>
                    <a class="collapse-item" th:href="@{/forgot-password}">Forgot Password</a>
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Other Pages:</h6>
                    <a class="collapse-item" th:href="@{/404}">404 Page</a>
                    <a class="collapse-item" th:href="@{/blank}">Blank Page</a>
                </div>
            </div>
        </li>

        <!-- Nav Item - Charts -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/charts}">
                <i class="fas fa-fw fa-chart-area"></i>
                <span>Charts</span></a>
        </li>

        <!-- Nav Item - Tables -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/tables}">
                <i class="fas fa-fw fa-table"></i>
                <span>Tables</span></a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block">

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
    </ul>
    
    <!-- Add some custom styling for company selector -->
    <style th:fragment="company-selector-styles">
        .selector-wrapper {
            position: relative;
            display: flex;
            justify-content: space-between;
            min-width: 184px;
            height: 45px;
        }
        
        .toggle-wrapper {
            display: flex;
            align-items: center;
        }
        
        .toggle-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: solid 1px #e2e2e2;
            cursor: pointer;
        }
        
        .logo-wrapper {
            position: relative;
            width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            background-color: #fff;
            border-radius: 6px;
        }
        
        .min-width-150 {
            min-width: 150px;
        }
        
        .cursor-pointer {
            cursor: pointer;
        }
    </style>
    
    <!-- Company Selector Script -->
    <script th:fragment="company-selector-script">
        document.addEventListener('DOMContentLoaded', function() {
            // Function to load companies
            function loadCompanies() {
                fetch('/api/companies-all')
                    .then(response => response.json())
                    .then(data => {
                        const companyList = document.getElementById('companyList');
                        const currentDisplay = document.getElementById('currentCompanyDisplay');
                        
                        // Clear loading messages
                        companyList.innerHTML = '';
                        currentDisplay.innerHTML = '';
                        
                        if (data.companies && data.companies.length > 0) {
                            // Find selected company
                            const selectedCompany = data.companies.find(c => c.id === data.selectedCompanyId) || data.companies[0];
                            
                            // Update current selection display
                            if (selectedCompany.logoUrl) {
                                const logo = document.createElement('img');
                                logo.src = selectedCompany.logoUrl;
                                logo.alt = selectedCompany.name;
                                logo.className = 'company-logo';
                                currentDisplay.appendChild(logo);
                            }
                            
                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = selectedCompany.name;
                            nameSpan.className = 'company-name';
                            currentDisplay.appendChild(nameSpan);
                            
                            // Create dropdown items
                            data.companies.forEach(company => {
                                const item = document.createElement('a');
                                item.className = 'dropdown-item d-flex align-items-center';
                                item.href = '#';
                                
                                // Highlight selected company
                                if (data.selectedCompanyId === company.id) {
                                    item.classList.add('active');
                                }
                                
                                // Create logo/company name display
                                if (company.logoUrl) {
                                    const logo = document.createElement('img');
                                    logo.src = company.logoUrl;
                                    logo.alt = company.name;
                                    logo.className = 'company-logo';
                                    item.appendChild(logo);
                                }
                                
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = company.name;
                                nameSpan.className = 'company-name';
                                item.appendChild(nameSpan);
                                
                                // Add click handler
                                item.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    selectCompany(company.id);
                                });
                                
                                companyList.appendChild(item);
                            });
                        } else {
                            companyList.innerHTML = '<div class="text-center p-2">No companies available</div>';
                            currentDisplay.innerHTML = '<span class="company-name">No companies available</span>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading companies:', error);
                        document.getElementById('companyList').innerHTML = '<div class="text-danger p-2">Failed to load companies</div>';
                        document.getElementById('currentCompanyDisplay').innerHTML = '<span class="company-name text-danger">Error loading companies</span>';
                    });
            }
            
            // Function to select a company
            function selectCompany(companyId) {
                fetch(`/api/companies-all/select/${companyId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to reflect the new selection
                        window.location.reload();
                    } else {
                        alert('Failed to select company: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error selecting company:', error);
                    alert('Failed to select company. Please try again.');
                });
            }
            
            // Toggle dropdown on button click
            const toggleButtons = document.querySelectorAll('.toggle-button');
            const dropdownContent = document.querySelector('.dropdown-content');
            const dropdownMask = document.querySelector('.dropdown-mask');
            
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    dropdownContent.classList.toggle('show');
                });
            });
            
            // Close dropdown when clicking outside
            if (dropdownMask) {
                dropdownMask.addEventListener('click', function() {
                    dropdownContent.classList.remove('show');
                });
            }
            
            // Close dropdown when clicking on document
            document.addEventListener('click', function(event) {
                const isClickInside = event.target.closest('.company-selector');
                if (!isClickInside) {
                    dropdownContent.classList.remove('show');
                }
            });
            
            // Load companies when the page loads
            loadCompanies();
        });
    </script>
</body>
</html>