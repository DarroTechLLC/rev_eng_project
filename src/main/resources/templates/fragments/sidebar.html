<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <!-- Sidebar Fragment -->
    <ul th:fragment="sidebar" class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <!-- Sidebar - Company Selector -->
        <div class="sidebar-brand d-flex align-items-center justify-content-between p-2" id="companySelector">
            <div class="selector-wrapper position-relative">
                <div class="d-flex justify-content-between min-width-150" id="currentCompanyDisplay">
                    <!-- Show selected company logo if available -->
                    <div class="logo-wrapper d-flex align-items-center justify-content-center">
                        <img th:if="${selectedCompany != null && selectedCompany.logoUrl != null}" 
                             th:src="${selectedCompany.logoUrl}" 
                             class="img-fluid" 
                             alt="Company Logo"
                             style="height: 45px;">
                        <div th:unless="${selectedCompany != null && selectedCompany.logoUrl != null}" 
                             class="text-center font-weight-bold p-2">
                            <span th:text="${selectedCompany != null ? selectedCompany.name : 'Select Company'}">
                                Select Company
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="toggle-wrapper">
                    <div class="toggle-button rounded bg-white p-1 cursor-pointer" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-chevron-down text-primary"></i>
                    </div>
                </div>
            </div>
            
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="companyDropdown" id="companyDropdownMenu">
                <!-- This will be populated via JavaScript -->
                <div class="dropdown-header">Select a company</div>
                <div class="dropdown-divider"></div>
                <div id="companyList" class="p-2">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <span class="ml-2">Loading companies...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">

        <!-- Nav Item - Dashboard -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/}">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </li>

        <!-- Nav Item - Farm Management -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/admin/farms}">
                <i class="fas fa-fw fa-barn"></i>
                <span>Farms</span>
            </a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Interface
        </div>

        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-fw fa-cog"></i>
                <span>Components</span>
            </a>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Custom Components:</h6>
                    <a class="collapse-item" th:href="@{/buttons}">Buttons</a>
                    <a class="collapse-item" th:href="@{/cards}">Cards</a>
                </div>
            </div>
        </li>

        <!-- Nav Item - Utilities Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                aria-expanded="true" aria-controls="collapseUtilities">
                <i class="fas fa-fw fa-wrench"></i>
                <span>Utilities</span>
            </a>
            <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Custom Utilities:</h6>
                    <a class="collapse-item" th:href="@{/utilities-color}">Colors</a>
                    <a class="collapse-item" th:href="@{/utilities-border}">Borders</a>
                    <a class="collapse-item" th:href="@{/utilities-animation}">Animations</a>
                    <a class="collapse-item" th:href="@{/utilities-other}">Other</a>
                </div>
            </div>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Addons
        </div>

        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link" href="#" data-toggle="collapse" data-target="#collapsePages" aria-expanded="true"
                aria-controls="collapsePages">
                <i class="fas fa-fw fa-folder"></i>
                <span>Pages</span>
            </a>
            <div id="collapsePages" class="collapse" aria-labelledby="headingPages"
                data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Login Screens:</h6>
                    <a class="collapse-item" th:href="@{/login}">Login</a>
                    <a class="collapse-item" th:href="@{/register}">Register</a>
                    <a class="collapse-item" th:href="@{/forgot-password}">Forgot Password</a>
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Other Pages:</h6>
                    <a class="collapse-item" th:href="@{/404}">404 Page</a>
                    <a class="collapse-item" th:href="@{/blank}">Blank Page</a>
                </div>
            </div>
        </li>

        <!-- Nav Item - Charts -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/charts}">
                <i class="fas fa-fw fa-chart-area"></i>
                <span>Charts</span></a>
        </li>

        <!-- Nav Item - Tables -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/tables}">
                <i class="fas fa-fw fa-table"></i>
                <span>Tables</span></a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block">

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
    </ul>
    
    <!-- Add some custom styling for company selector -->
    <style th:fragment="company-selector-styles">
        .selector-wrapper {
            position: relative;
            display: flex;
            justify-content: space-between;
            min-width: 184px;
            height: 45px;
        }
        
        .toggle-wrapper {
            display: flex;
            align-items: center;
        }
        
        .toggle-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: solid 1px #e2e2e2;
            cursor: pointer;
        }
        
        .logo-wrapper {
            position: relative;
            width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            background-color: #fff;
            border-radius: 6px;
        }
        
        .min-width-150 {
            min-width: 150px;
        }
        
        .cursor-pointer {
            cursor: pointer;
        }
    </style>
    
    <!-- Add JavaScript for company selector functionality -->
    <script th:fragment="company-selector-script">
        document.addEventListener('DOMContentLoaded', function() {
            // Function to load companies
            function loadCompanies() {
                fetch('/api/companies-all')
                    .then(response => response.json())
                    .then(data => {
                        const companyList = document.getElementById('companyList');
                        
                        // Clear loading message
                        companyList.innerHTML = '';
                        
                        if (data.companies && data.companies.length > 0) {
                            // Create company items
                            data.companies.forEach(company => {
                                const item = document.createElement('a');
                                item.className = 'dropdown-item d-flex align-items-center';
                                item.href = '#';
                                
                                // Highlight selected company
                                if (data.selectedCompanyId === company.id) {
                                    item.classList.add('active', 'bg-primary', 'text-white');
                                }
                                
                                // Create logo/icon
                                const logoContainer = document.createElement('div');
                                logoContainer.className = 'mr-2';
                                
                                if (company.logoUrl) {
                                    const logo = document.createElement('img');
                                    logo.src = company.logoUrl;
                                    logo.alt = company.name;
                                    logo.className = 'img-fluid';
                                    logo.style.maxHeight = '30px';
                                    logo.style.maxWidth = '30px';
                                    logoContainer.appendChild(logo);
                                } else {
                                    // Create a placeholder with company name initials
                                    const placeholder = document.createElement('div');
                                    placeholder.className = 'company-placeholder d-flex justify-content-center align-items-center bg-secondary text-white rounded';
                                    placeholder.style.width = '30px';
                                    placeholder.style.height = '30px';
                                    placeholder.style.fontWeight = 'bold';
                                    placeholder.textContent = company.name.substring(0, 1).toUpperCase();
                                    logoContainer.appendChild(placeholder);
                                }
                                
                                // Create company name
                                const nameContainer = document.createElement('div');
                                nameContainer.textContent = company.name;
                                
                                // Append elements
                                item.appendChild(logoContainer);
                                item.appendChild(nameContainer);
                                
                                // Add click handler
                                item.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    selectCompany(company.id);
                                });
                                
                                companyList.appendChild(item);
                            });
                        } else {
                            companyList.innerHTML = '<div class="text-center p-2">No companies available</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading companies:', error);
                        document.getElementById('companyList').innerHTML = 
                            '<div class="text-center text-danger">Failed to load companies</div>';
                    });
            }
            
            // Function to select a company
            function selectCompany(companyId) {
                fetch(`/api/companies-all/select/${companyId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to reflect the new selection
                        window.location.reload();
                    } else {
                        alert('Failed to select company: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error selecting company:', error);
                    alert('Failed to select company. Please try again.');
                });
            }
            
            // Load companies when the page loads
            loadCompanies();
        });
    </script>
</body>
</html>