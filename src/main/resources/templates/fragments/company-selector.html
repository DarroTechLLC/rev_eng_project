<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- Company Selector Component -->
    <div th:fragment="company-selector" class="company-selector">
        <!-- Company Dropdown -->
        <div class="dropdown">
            <!-- Current Selection Display -->
            <div id="currentCompanyDisplay" class="d-flex align-items-center">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <!-- Dropdown Content -->
            <div class="dropdown-content" id="companyList">
                <div class="text-center p-2">Loading companies...</div>
            </div>
            
            <!-- Dropdown Mask -->
            <div class="dropdown-mask"></div>
            
            <!-- Toggle Button -->
            <div class="toggle-wrapper">
                <div class="toggle-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <img src="/svg/down-arrow.svg" alt="Open"/>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Script Fragment -->
    <th:block th:fragment="company-selector-script">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Function to load companies
                function loadCompanies() {
                    fetch('/api/companies-all')
                        .then(response => response.json())
                        .then(data => {
                            const companyList = document.getElementById('companyList');
                            const currentDisplay = document.getElementById('currentCompanyDisplay');
                            
                            // Clear loading messages
                            companyList.innerHTML = '';
                            currentDisplay.innerHTML = '';
                            
                            if (data.companies && data.companies.length > 0) {
                                // Find selected company
                                const selectedCompany = data.companies.find(c => c.id === data.selectedCompanyId) || data.companies[0];
                                
                                // Update current selection display
                                if (selectedCompany.logoUrl) {
                                    const logo = document.createElement('img');
                                    logo.src = selectedCompany.logoUrl;
                                    logo.alt = selectedCompany.name;
                                    logo.className = 'company-logo';
                                    currentDisplay.appendChild(logo);
                                }
                                
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = selectedCompany.name;
                                nameSpan.className = 'company-name';
                                currentDisplay.appendChild(nameSpan);
                                
                                // Create dropdown items
                                data.companies.forEach(company => {
                                    const item = document.createElement('a');
                                    item.className = 'dropdown-item d-flex align-items-center';
                                    item.href = '#';
                                    
                                    // Highlight selected company
                                    if (data.selectedCompanyId === company.id) {
                                        item.classList.add('active');
                                    }
                                    
                                    // Create logo/company name display
                                    if (company.logoUrl) {
                                        const logo = document.createElement('img');
                                        logo.src = company.logoUrl;
                                        logo.alt = company.name;
                                        logo.className = 'company-logo';
                                        item.appendChild(logo);
                                    }
                                    
                                    const nameSpan = document.createElement('span');
                                    nameSpan.textContent = company.name;
                                    nameSpan.className = 'company-name';
                                    item.appendChild(nameSpan);
                                    
                                    // Add click handler
                                    item.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        selectCompany(company.id);
                                    });
                                    
                                    companyList.appendChild(item);
                                });
                            } else {
                                companyList.innerHTML = '<div class="text-center p-2">No companies available</div>';
                                currentDisplay.innerHTML = '<span class="company-name">No companies available</span>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading companies:', error);
                            document.getElementById('companyList').innerHTML = '<div class="text-danger p-2">Failed to load companies</div>';
                            document.getElementById('currentCompanyDisplay').innerHTML = '<span class="company-name text-danger">Error loading companies</span>';
                        });
                }
                
                // Function to select company
                function selectCompany(companyId) {
                    fetch('/api/set-company/' + companyId, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Failed to switch company: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error switching company:', error);
                        alert('Failed to switch company due to a network error');
                    });
                }
                
                // Initialize company selector
                loadCompanies();
                
                // Add click handler for dropdown toggle
                document.querySelector('.toggle-button').addEventListener('click', function() {
                    document.querySelector('.dropdown-content').classList.toggle('show');
                });
                
                // Close dropdown when clicking outside
                document.querySelector('.dropdown-mask').addEventListener('click', function() {
                    document.querySelector('.dropdown-content').classList.remove('show');
                });
            });
        </script>
    </th:block>
</body>
</html> 